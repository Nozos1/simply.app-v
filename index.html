<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Simply App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; padding: 2rem; }
    input, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
    td, th { border: 1px solid #333; padding: 0.5rem; }
    #preview { margin-bottom: 1rem; }
    #summary { margin-bottom: 1rem; font-weight: bold; }
    #dayList ul { list-style: none; padding-left: 0; }
    #dayList li { padding: 0.3rem; border-bottom: 1px solid #333; cursor: pointer; }
    #dayList li:hover { background: #222; }
    #qr-scanner { position: relative; width: 100%; max-width: 400px; margin: 0 auto; display: none; }
    #qr-scanner video { width: 100%; border: 2px solid #4CAF50; border-radius: 8px; }
    #close-scanner { margin-top: 10px; padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .scan-button { background: #4CAF50; color: white; padding: 10px 20px; font-size: 16px; margin: 10px 0; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Simply App</h1>
  
  <button class="scan-button" onclick="startScanner()">Skanuj kod QR</button>
  <br>
  
  <div id="qr-scanner">
    <div id="reader"></div>
    <button id="close-scanner">Zamknij skaner</button>
  </div>
  
  <input type="text" id="qrResult" placeholder="Kod QR" readonly><br>
  <input type="text" id="idInput" placeholder="Wpisz ID"><br>
  <input type="number" id="qtyInput" placeholder="Ilość"><br>
  <input type="number" id="powerInput" placeholder="Moc (W)"><br>
  <button onclick="saveEntry()">Zapisz</button>
  <button onclick="exportCSV()">Eksportuj CSV</button>
  <button onclick="clearData()">Wyczyść dane</button>
  <button onclick="endDay()">Zakończ dzień</button>

  <h2 id="summary">Suma ilości: 0</h2>
  <table id="dataTable">
    <thead><tr><th>Kod QR</th><th>ID</th><th>Ilość</th><th>Moc (W)</th><th>GPS</th><th>Czas</th><th>Usuń</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="dayList" style="margin-top: 2rem; text-align: left;"></div>
  
  <button onclick="resetLampInventory()" style="margin-top:1rem;">🔄 Resetuj stan lamp</button>

  <div id="lampInventory" style="margin-top:2rem; text-align:left; display:none;"></div>
  <button onclick="toggleLampInventory()" style="margin-top:1rem;">📉 Stan lamp</button>

  <div id="lampReport" style="margin-top:2rem; text-align:left; display:none;"></div>
  <button onclick="showLampReport()" style="margin-top:1rem;">📊 Raport montażu</button>
  <div id="totalSum" style="margin-top: 1rem; font-weight: bold;"></div>
  
  <button onclick="clearArchive()" style="margin-top:2rem;">🗑️ Usuń wszystkie dni</button>
  <button onclick="toggleLampSummary()" style="margin-top:1rem;">💡 Lampy</button>

  <div id="lampSummary" style="margin-top:3rem; text-align:left; display:none;">
    <h3>Planowane lampy do montażu:</h3>
    <table style="border-collapse: collapse; width: 100%; max-width: 400px;">
      <thead><tr><th style='border:1px solid #333; padding:5px;'>Model</th><th style='border:1px solid #333; padding:5px;'>Moc (W)</th><th style='border:1px solid #333; padding:5px;'>Ilość</th></tr></thead>
      <tbody>
        <tr><td style='border:1px solid #333; padding:5px;'>SAWA</td><td style='border:1px solid #333; padding:5px;'>29</td><td style='border:1px solid #333; padding:5px;'>40</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>46</td><td style='border:1px solid #333; padding:5px;'>167</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>25</td><td style='border:1px solid #333; padding:5px;'>161</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>36</td><td style='border:1px solid #333; padding:5px;'>20</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>38</td><td style='border:1px solid #333; padding:5px;'>16</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>40</td><td style='border:1px solid #333; padding:5px;'>153</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>54</td><td style='border:1px solid #333; padding:5px;'>111</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>30</td><td style='border:1px solid #333; padding:5px;'>9</td></tr>
        <tr><td style='border:1px solid #333; padding:5px;'>Urbino</td><td style='border:1px solid #333; padding:5px;'>50</td><td style='border:1px solid #333; padding:5px;'>4</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Użyj najnowszej wersji biblioteki -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  
  <script>
    let data = JSON.parse(localStorage.getItem("simply_data")) || [];
    let html5QrCode = null;
    let isScanning = false;

    // Inicjalizacja po załadowaniu strony
    window.addEventListener("DOMContentLoaded", function() {
      // Załaduj dane
      const table = document.querySelector("#dataTable tbody");
      data.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = rowHTML(row, i);
        table.appendChild(tr);
      });
      updateSummary();
      renderDayList();
      updateLampInventoryDisplay();
      
      // Obsługa przycisku zamykania skanera
      document.getElementById("close-scanner").addEventListener("click", stopScanner);
      
      console.log("Aplikacja załadowana. Html5Qrcode dostępny:", typeof Html5Qrcode !== 'undefined');
    });

    // Poprawiona funkcja startScanner
    function startScanner() {
      console.log("Rozpoczynanie skanowania...");
      
      // Sprawdź czy biblioteka jest dostępna
      if (typeof Html5Qrcode === 'undefined') {
        alert("Błąd: Biblioteka skanera nie została załadowana. Odśwież stronę.");
        console.error("Html5Qrcode is not defined");
        return;
      }
      
      const scannerDiv = document.getElementById("qr-scanner");
      scannerDiv.style.display = "block";
      
      if (isScanning) {
        console.log("Skaner już działa");
        return;
      }
      
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          
          // Utwórz nową instancję skanera
          html5QrCode = new Html5Qrcode("reader");
          
          html5QrCode.start(
            cameraId,
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
              facingMode: "environment"
            },
            (qrCodeMessage) => {
              // Kod QR zeskanowany pomyślnie
              console.log("Zeskanowano kod:", qrCodeMessage);
              document.getElementById("qrResult").value = qrCodeMessage;
              stopScanner();
            },
            (errorMessage) => {
              // Pomijamy komunikaty o błędach, chyba że jest to krytyczny błąd
              console.log("Skanowanie:", errorMessage);
            }
          ).then(() => {
            isScanning = true;
            console.log("Skaner uruchomiony pomyślnie");
          }).catch(err => {
            console.error("Błąd uruchamiania skanera:", err);
            alert("Nie można uruchomić kamery: " + err);
            scannerDiv.style.display = "none";
          });
        }
      }).catch(err => {
        console.error("Błąd pobierania listy kamer:", err);
        alert("Nie można uzyskać dostępu do kamery: " + err);
        scannerDiv.style.display = "none";
      });
    }

    // Funkcja do zatrzymywania skanera
    function stopScanner() {
      const scannerDiv = document.getElementById("qr-scanner");
      
      if (html5QrCode && isScanning) {
        html5QrCode.stop().then(() => {
          console.log("Skaner QR zatrzymany");
          isScanning = false;
          scannerDiv.style.display = "none";
        }).catch(err => {
          console.error("Błąd zatrzymywania skanera:", err);
          isScanning = false;
          scannerDiv.style.display = "none";
        });
      } else {
        scannerDiv.style.display = "none";
        isScanning = false;
      }
    }

    function saveEntry() {
      const qr = document.getElementById("qrResult").value;
      const id = document.getElementById("idInput").value;
      const qty = parseInt(document.getElementById("qtyInput").value) || 0;
      const power = parseInt(document.getElementById("powerInput").value) || 0;
      
      if (!qr) return alert("Najpierw zeskanuj kod QR.");
      if (!navigator.geolocation) return alert("Twoja przeglądarka nie obsługuje geolokalizacji.");

      navigator.geolocation.getCurrentPosition(pos => {
        const gps = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        const time = new Date().toLocaleString();
        const row = { qr, id, qty, power, gps, time };
        data.push(row);
        localStorage.setItem("simply_data", JSON.stringify(data));
        const tr = document.createElement("tr");
        tr.innerHTML = rowHTML(row, data.length - 1);
        document.querySelector("#dataTable tbody").appendChild(tr);
        updateSummary();
        decrementLampInventory(power);
        
        // Wyczyść pole kodu QR po zapisaniu
        document.getElementById("qrResult").value = "";
      }, err => alert("Nie udało się pobrać lokalizacji: " + err.message), { 
        enableHighAccuracy: true, 
        timeout: 10000, 
        maximumAge: 0 
      });
    }

    function rowHTML(row, index) {
      return `
        <td>${row.qr}</td>
        <td contenteditable="true" onblur="updateID(${index}, this.textContent)" onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}">${row.id}</td>
        <td>${row.qty}</td>
        <td>${row.power ?? ""}</td>
        <td>${row.gps}</td>
        <td>${row.time}</td>
        <td><button onclick="deleteEntry(${index})">🗑️</button></td>
      `;
    }

    function updateID(index, newID) {
      data[index].id = newID.trim();
      localStorage.setItem("simply_data", JSON.stringify(data));
    }

    function updateSummary() {
      const sum = data.reduce((total, row) => total + row.qty, 0);
      document.getElementById("summary").textContent = "Suma ilości: " + sum;
    }

    function exportCSV() {
      let csv = "Kod QR,ID,Ilość,Moc (W),GPS,Czas\n";
      data.forEach(row => {
        csv += `${row.qr},${row.id},${row.qty},${row.power ?? ""},${row.gps},${row.time}\n`;
      });
      
      let inventory = JSON.parse(localStorage.getItem("lamp_inventory")) || {};
      csv += "\nPozostały stan lamp:\nMoc (W),Pozostało\n";
      Object.keys(inventory).sort((a, b) => a - b).forEach(key => {
        csv += `${key},${inventory[key]}\n`;
      });
      
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "simply_data.csv";
      a.click();
    }

    function clearData() {
      if (confirm("Czy na pewno chcesz wyczyścić wszystkie dane?")) {
        localStorage.removeItem("simply_data");
        data = [];
        document.querySelector("#dataTable tbody").innerHTML = "";
        updateSummary();
      }
    }

    function deleteEntry(index) {
      if (confirm("Czy na pewno chcesz usunąć ten wpis?")) {
        const power = data[index].power;
        data.splice(index, 1);
        localStorage.setItem("simply_data", JSON.stringify(data));
        const table = document.querySelector("#dataTable tbody");
        table.innerHTML = "";
        data.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = rowHTML(row, i);
          table.appendChild(tr);
        });
        updateSummary();
        
        // Przywróć liczbę lamp w inwentarzu
        if (power && lampInventory.hasOwnProperty(power)) {
          lampInventory[power] += 1;
          localStorage.setItem("lamp_inventory", JSON.stringify(lampInventory));
          updateLampInventoryDisplay();
        }
      }
    }

    function endDay() {
      if (data.length === 0) return alert("Brak danych do zapisania.");
      const today = new Date().toISOString().slice(0, 10);
      let archive = JSON.parse(localStorage.getItem("simply_archive")) || {};
      archive[today] = data;
      localStorage.setItem("simply_archive", JSON.stringify(archive));
      clearData();
      renderDayList();
    }

    function renderDayList() {
      const archive = JSON.parse(localStorage.getItem("simply_archive")) || {};
      const container = document.getElementById("dayList");
      container.innerHTML = "<h3>Zapisane dni:</h3>";
      if (Object.keys(archive).length === 0) return container.innerHTML += "<p>Brak zapisanych dni.</p>";
      const ul = document.createElement("ul");
      let totalSum = 0;
      for (let date in archive) {
        const dayEntries = archive[date];
        const daySum = dayEntries.reduce((sum, row) => sum + row.qty, 0);
        totalSum += daySum;
        const li = document.createElement("li");
        li.textContent = `${date} – ${dayEntries.length} wpisów (Suma: ${daySum})`;
        li.onclick = () => showDay(date);
        ul.appendChild(li);
      }
      container.appendChild(ul);
      document.getElementById("totalSum").textContent = "Łączna suma ilości: " + totalSum;
    }

    function showDay(date) {
      const archive = JSON.parse(localStorage.getItem("simply_archive")) || {};
      let rows = archive[date];
      if (!rows) return;
      let tableHTML = `<h3>Dane z dnia ${date}</h3><table style="width:100%; border-collapse: collapse;"><thead><tr><th>Kod QR</th><th>ID</th><th>Ilość</th><th>Moc (W)</th><th>GPS</th><th>Czas</th><th>Usuń</th></tr></thead><tbody>`;
      rows.forEach((row, i) => {
        tableHTML += `<tr><td>${row.qr}</td><td>${row.id}</td><td>${row.qty}</td><td>${row.power ?? ""}</td><td>${row.gps}</td><td>${row.time}</td><td><button onclick="deleteFromDay('${date}', ${i})">🗑️</button></td></tr>`;
      });
      tableHTML += "</tbody></table>";
      document.getElementById("dayList").innerHTML = tableHTML + '<button onclick="renderDayList()">⬅️ Wróć do listy dni</button>';
    }

    function deleteFromDay(date, index) {
      let archive = JSON.parse(localStorage.getItem("simply_archive")) || {};
      if (!archive[date]) return;
      archive[date].splice(index, 1);
      if (archive[date].length === 0) {
        delete archive[date];
        renderDayList();
      } else {
        showDay(date);
      }
      localStorage.setItem("simply_archive", JSON.stringify(archive));
    }

    function clearArchive() {
      if (confirm("Czy na pewno chcesz usunąć wszystkie zapisane dni?")) {
        localStorage.removeItem("simply_archive");
        renderDayList();
        document.getElementById("dayList").innerHTML = "<h3>Zapisane dni:</h3><p>Brak zapisanych dni.</p>";
        document.getElementById("totalSum").textContent = "";
      }
    }

    // Funkcje zarządzania inwentarzem lamp
    const defaultInventory = {
      29: 40,
      46: 167,
      25: 161,
      36: 20,
      38: 16,
      40: 153,
      54: 111,
      30: 9,
      50: 4
    };

    let lampInventory = JSON.parse(localStorage.getItem("lamp_inventory")) || { ...defaultInventory };

    function updateLampInventoryDisplay() {
      let html = "<h3>Pozostałe lampy do montażu:</h3><table style='border-collapse: collapse; width:100%; max-width:400px;'>";
      html += "<thead><tr><th style='border:1px solid #333; padding:5px;'>Moc (W)</th><th style='border:1px solid #333; padding:5px;'>Pozostało</th></tr></thead><tbody>";
      const keys = Object.keys(lampInventory).sort((a,b) => a-b);
      for (let moc of keys) {
        html += `<tr><td style='border:1px solid #333; padding:5px;'>${moc}</td><td style='border:1px solid #333; padding:5px;'>${lampInventory[moc]}</td></tr>`;
      }
      html += "</tbody></table>";
      document.getElementById("lampInventory").innerHTML = html;
    }

    function decrementLampInventory(power) {
      if (lampInventory.hasOwnProperty(power)) {
        lampInventory[power] = Math.max(0, lampInventory[power] - 1);
        localStorage.setItem("lamp_inventory", JSON.stringify(lampInventory));
        updateLampInventoryDisplay();
      }
    }

    function resetLampInventory() {
      if (confirm("Przywrócić domyślny stan lamp?")) {
        lampInventory = { ...defaultInventory };
        localStorage.setItem("lamp_inventory", JSON.stringify(lampInventory));
        updateLampInventoryDisplay();
      }
    }

    function toggleLampInventory() {
      const section = document.getElementById("lampInventory");
      section.style.display = section.style.display === "none" ? "block" : "none";
    }

    function showLampReport() {
      const reportDiv = document.getElementById("lampReport");
      const initialInventory = defaultInventory;

      let html = "<h3>Raport stanu lamp:</h3><table style='border-collapse: collapse; width:100%; max-width:400px;'>";
      html += "<thead><tr><th style='border:1px solid #333; padding:5px;'>Moc (W)</th><th style='border:1px solid #333; padding:5px;'>Zamontowano</th><th style='border:1px solid #333; padding:5px;'>Pozostało</th></tr></thead><tbody>";

      Object.keys(initialInventory).sort((a,b) => a-b).forEach(moc => {
        const total = initialInventory[moc];
        const left = lampInventory[moc] ?? total;
        const used = total - left;
        html += `<tr><td style='border:1px solid #333; padding:5px;'>${moc}</td><td style='border:1px solid #333; padding:5px;'>${used}</td><td style='border:1px solid #333; padding:5px;'>${left}</td></tr>`;
      });

      html += "</tbody></table>";
      reportDiv.innerHTML = html;
      reportDiv.style.display = "block";
    }

    function toggleLampSummary() {
      const section = document.getElementById("lampSummary");
      if (section.style.display === "none") {
        section.style.display = "block";
      } else {
        section.style.display = "none";
      }
    }
  </script>
</body>
</html>
