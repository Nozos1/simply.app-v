
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Simply App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; padding: 2rem; }
    input, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
    td, th { border: 1px solid #333; padding: 0.5rem; }
    #preview { margin-bottom: 1rem; }
    #summary { margin-bottom: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Simply App</h1>
  <div id="preview" style="width:300px;height:200px;margin:0 auto;"></div><br>
  <button onclick="startScanner()">Skanuj kod QR</button><br>
  <input type="text" id="qrResult" placeholder="Kod QR" readonly><br>
  <input type="text" id="idInput" placeholder="Wpisz ID"><br>
  <input type="number" id="qtyInput" placeholder="Ilość"><br>
  <input type="number" id="powerInput" placeholder="Moc (W)"><br>
  <button onclick="saveEntry()">Zapisz</button>
  <button onclick="exportCSV()">Eksportuj CSV</button>
  <button onclick="clearData()">Wyczyść dane</button>
  <h2 id="summary">Suma ilości: 0</h2>
  <table id="dataTable">
    <thead><tr><th>Kod QR</th><th>ID</th><th>Ilość</th><th>MOC (W)</th><th>GPS</th><th>Czas</th></tr></thead>
    <tbody></tbody>
  </table>

<script>
let scanner;
let data = JSON.parse(localStorage.getItem("simply_data")) || [];
const defaultInventory = { 29: 40, 46: 167, 25: 161, 36: 20, 38: 16, 40: 153, 54: 111, 30: 9, 50: 4 };
let lampInventory = JSON.parse(localStorage.getItem("lamp_inventory")) || {...defaultInventory};

window.onload = () => {
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = rowHTML(row);
    document.querySelector("tbody").appendChild(tr);
  });
  updateSummary();
};

function startScanner() {
  if (!scanner) scanner = new Html5Qrcode("preview");
  else scanner.clear().catch(() => {});
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, qr => {
    document.getElementById("qrResult").value = qr;
    scanner.stop().then(() => document.getElementById("preview").innerHTML = "");
  }).catch(e => alert("Błąd kamery: " + e));
}

function saveEntry() {
  const qr = document.getElementById("qrResult").value;
  const id = document.getElementById("idInput").value;
  const qty = parseInt(document.getElementById("qtyInput").value) || 0;
  const power = parseInt(document.getElementById("powerInput").value) || 0;
  if (!qr) return alert("Brak kodu QR.");
  if (!navigator.geolocation) return alert("Brak wsparcia GPS.");

  navigator.geolocation.getCurrentPosition(pos => {
    const gps = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
    const time = new Date().toLocaleString();
    const row = { qr, id, qty, power, gps, time };
    data.push(row);
    localStorage.setItem("simply_data", JSON.stringify(data));
    const tr = document.createElement("tr");
    tr.innerHTML = rowHTML(row);
    document.querySelector("tbody").appendChild(tr);
    if (lampInventory[power] !== undefined) {
      lampInventory[power] = Math.max(0, lampInventory[power] - qty);
      localStorage.setItem("lamp_inventory", JSON.stringify(lampInventory));
    }
    updateSummary();
  }, err => alert("Błąd GPS: " + err.message));
}

function rowHTML(row) {
  return `<td>${row.qr}</td><td>${row.id}</td><td>${row.qty}</td><td>${row.power}</td><td>${row.gps}</td><td>${row.time}</td>`;
}

function updateSummary() {
  const sum = data.reduce((acc, r) => acc + r.qty, 0);
  document.getElementById("summary").textContent = "Suma ilości: " + sum;
}

function exportCSV() {
  let csv = "Kod QR,ID,Ilość,MOC (W),GPS,Czas\n";
  data.forEach(r => {
    csv += `${r.qr},${r.id},${r.qty},${r.power},${r.gps},${r.time}\n`;
  });
  csv += "\nMOC (W),Zamontowano,Pozostało\n";
  for (let m in defaultInventory) {
    const used = defaultInventory[m] - (lampInventory[m] ?? defaultInventory[m]);
    csv += `${m},${used},${lampInventory[m] ?? defaultInventory[m]}\n`;
  }
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "simply_data.csv";
  a.click();
}

function clearData() {
  if (confirm("Czy na pewno wyczyścić dane?")) {
    data = [];
    localStorage.removeItem("simply_data");
    document.querySelector("tbody").innerHTML = "";
    updateSummary();
  }
}
</script>
</body>
</html>
